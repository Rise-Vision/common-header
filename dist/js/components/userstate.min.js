!function(e){"use strict";try{e.module("risevision.common.config")}catch(o){e.module("risevision.common.config",[])}e.module("risevision.common.config").value("ENABLE_EXTERNAL_LOGGING",!0).value("CORE_URL","https://rvaserver2.appspot.com/_ah/api"),e.module("risevision.common.components.logging",[]),e.module("risevision.common.components.rvtokenstore",["risevision.common.components.util","LocalStorageModule","ngBiscuit"]),e.module("risevision.common.components.userstate",["ui.router","angular-md5","risevision.common.components.ui-flow","risevision.common.components.util","risevision.common.components.rvtokenstore","risevision.common.components.logging","risevision.common.components.loading","risevision.common.config","risevision.common.gapi","LocalStorageModule","risevision.core.cache","risevision.core.oauth2","risevision.core.company","risevision.core.util","risevision.core.userprofile"]).config(["$urlRouterProvider","$urlMatcherFactoryProvider","$stateProvider","$locationProvider",function(e,o,t,n){n.html5Mode(!0),n.hashPrefix("/"),e.when(/\/.*&id_token=.*&client_id=.*/,function(){console.log("Google Auth result received")}).when("/",["$location",function(e){var o=e.hash();return!(!o||!o.match(/\/.*&id_token=.*&client_id=.*/))&&void console.log("Google Auth result received")}]).otherwise("/"),o.strictMode(!1),t.state("common",{template:'<div class="app-launcher" ui-view></div>'}).state("common.auth",{"abstract":!0,templateProvider:["$templateCache",function(e){return e.get("userstate/auth-common.html")}]}).state("common.auth.unauthorized",{templateProvider:["$templateCache",function(e){return e.get("userstate/login.html")}],url:"/unauthorized/:state",controller:"LoginCtrl",params:{isSignUp:!1,passwordReset:null,accountConfirmed:null}}).state("common.auth.createaccount",{templateProvider:["$templateCache",function(e){return e.get("userstate/create-account.html")}],url:"/createaccount/:state",controller:"LoginCtrl",params:{isSignUp:!0,joinAccount:!1}}).state("common.auth.joinaccount",{templateProvider:["$templateCache",function(e){return e.get("userstate/create-account.html")}],url:"/joinaccount/:companyName",controller:"LoginCtrl",params:{isSignUp:!0,joinAccount:!0}}).state("common.auth.confirmaccount",{controller:"ConfirmAccountCtrl",template:"<div ui-view></div>",url:"/confirmaccount/:user/:token"}).state("common.auth.requestconfirmationemail",{templateProvider:["$templateCache",function(e){return e.get("userstate/request-confirmation-email.html")}],url:"/requestconfirmationemail",controller:"RequestConfirmationEmailCtrl"}).state("common.auth.requestpasswordreset",{templateProvider:["$templateCache",function(e){return e.get("userstate/request-password-reset.html")}],url:"/requestpasswordreset",controller:"RequestPasswordResetCtrl"}).state("common.auth.resetpassword",{templateProvider:["$templateCache",function(e){return e.get("userstate/reset-password-confirm.html")}],url:"/resetpassword/:user/:token",controller:"ResetPasswordConfirmCtrl"}).state("common.auth.unsubscribe",{templateProvider:["$templateCache",function(e){return e.get("userstate/unsubscribe.html")}],url:"/unsubscribe",controller:["$scope","$location",function(e,o){var t=o.path("/unsubscribe").search();e.email=t.email,e.id=t.id,e.name=t.name}]})}]).run(["$rootScope","$state","$stateParams","urlStateService","userState",function(e,o,t,n,r){r._restoreState(),e.$on("$stateChangeStart",function(e,t,n,r,s){!t||"common.auth.unauthorized"!==t.name&&"common.auth.unregistered"!==t.name&&"common.auth.createaccount"!==t.name||n.state||s.state&&(n.state=s.state,e.preventDefault(),o.go(t.name,n))}),e.$on("risevision.user.authorized",function(){var e=o.current.name;e.indexOf("common.auth")!==-1&&"common.auth.unsubscribe"!==e&&n.redirectToState(t.state)})}])}(angular),angular.module("risevision.common.components.userstate").factory("canAccessApps",["$q","$state","$location","userState","userAuthFactory","urlStateService",function(e,o,t,n,r,s){return function(a,i){var c=e.defer();return r.authenticate(!1).then(function(){return n.isRiseVisionUser()?void c.resolve():e.reject()}).then(null,function(){var e;n.isLoggedIn()?o.get("common.auth.unregistered")&&(e="common.auth.unregistered"):e=a?"common.auth.createaccount":"common.auth.unauthorized",e?(o.go(e,{state:s.get()},{reload:!0}),i||t.replace(),c.reject()):c.resolve()}),c.promise}}]),angular.module("risevision.common.components.logging").factory("bigQueryLogging",["externalLogging","userState",function(e,o){var t={};return t.logEvent=function(t,n,r,s,a){return e.logEvent(t,n,r,s||o.getUsername(),a||o.getSelectedCompanyId())},t}]),function(e){"use strict";e.module("risevision.common.components.userstate").factory("companyState",["$location","getCompany","objectHelper","$rootScope","$log","$q",function(o,t,n,r,s,a){var i,c={userCompany:{},selectedCompany:{}},u=function(){n.clearObj(c.selectedCompany),n.clearObj(c.userCompany),s.debug("Company state has been reset.")};o.search().cid&&(s.debug("cid",o.search().cid,"saved for later processing."),i=o.search().cid);var l=function(){var e=a.defer();return t().then(function(e){var o=p.getSelectedCompanyId()?p.getSelectedCompanyId():i;return n.clearAndCopy(e,c.userCompany),m(o)}).then(null,function(){p.resetCompany()})["finally"](function(){i=null,e.resolve(null)}),e.promise},m=function(e){var o=a.defer();return e&&e!==c.userCompany.id?t(e).then(function(e){n.clearAndCopy(e,c.selectedCompany),o.resolve(),r.$broadcast("risevision.company.selectedCompanyChanged")}).then(null,function(e){console.error("Failed to load selected company.",e),o.reject(e)}):(p.resetCompany(),o.resolve()),o.promise},d=function(){var e=a.defer();return t(c.selectedCompany.id).then(function(o){n.clearAndCopy(o,c.selectedCompany),e.resolve(),r.$broadcast("risevision.company.updated",{companyId:o.id})}).then(null,function(o){console.error("Failed to reload selected company.",o),e.reject(o)}),e.promise},p={init:l,switchCompany:m,reloadSelectedCompany:d,updateCompanySettings:function(e){e&&e.id===p.getSelectedCompanyId()&&n.clearAndCopy(e,c.selectedCompany),e&&e.id===p.getUserCompanyId()&&n.clearAndCopy(e,c.userCompany),r.$broadcast("risevision.company.updated",{companyId:e.id})},resetCompany:function(){n.clearAndCopy(c.userCompany,c.selectedCompany),r.$broadcast("risevision.company.selectedCompanyChanged")},resetCompanyState:u,getUserCompanyId:function(){return c.userCompany&&c.userCompany.id||null},getUserCompanyName:function(){return c.userCompany&&c.userCompany.name||null},getSelectedCompanyId:function(){return c.selectedCompany&&c.selectedCompany.id||null},getSelectedCompanyName:function(){return c.selectedCompany&&c.selectedCompany.name||null},getSelectedCompanyCountry:function(){return c.selectedCompany&&c.selectedCompany.country||null},getCopyOfUserCompany:function(o){return o?e.extend({},c.userCompany):n.follow(c.userCompany)},getCopyOfSelectedCompany:function(o){return o?e.extend({},c.selectedCompany):n.follow(c.selectedCompany)},isSubcompanySelected:function(){return c.selectedCompany&&c.selectedCompany.id!==(c.userCompany&&c.userCompany.id)},isTestCompanySelected:function(){return c.selectedCompany&&c.selectedCompany.isTest===!0},isSeller:function(){return!(!c.selectedCompany||!c.selectedCompany.sellerId)},isRootCompany:function(){return c.userCompany&&!c.userCompany.parentId},isSelectedCompanyChargebee:function(){return c.selectedCompany&&"Chargebee"===c.selectedCompany.origin}};return p}])}(angular),function(e){"use strict";e.module("risevision.common.components.userstate").factory("customAuthFactory",["$q","$log","gapiLoader","userauth","userState",function(e,o,t,n,r){var s={};return s.authenticate=function(s){var a=e.defer(),i=r._state;return s&&s.username&&s.password?e.all([t(),n.login(s.username,s.password)]).then(function(e){var t=e[0],n=e[1]&&e[1].result;if(o.debug("JWT login result:",n),n&&n.item){var r={access_token:n.item,expires_in:"3600",token_type:"Bearer"};t.auth.setToken(r),a.resolve({email:s.username,token:r})}else a.reject("Invalid Auth Token (JWT)")}).then(null,function(e){a.reject(e)}):i.userToken&&i.userToken.token?t().then(function(e){e.auth.setToken(i.userToken.token),a.resolve(i.userToken)}):a.reject(),a.promise},s.addUser=function(o){var t=e.defer();return o&&o.username&&o.password?n.add(o.username,o.password).then(function(e){t.resolve(e)}).then(null,function(){t.reject()}):t.reject(),t.promise},s}])}(angular),angular.module("risevision.common.components.logging").constant("EXTERNAL_LOGGER_SERVICE_URL","https://www.googleapis.com/bigquery/v2/projects/client-side-events/datasets/Apps_Events/tables/TABLE_ID/insertAll").constant("EXTERNAL_LOGGER_REFRESH_URL","https://www.googleapis.com/oauth2/v3/token?client_id=1088527147109-6q1o2vtihn34292pjt4ckhmhck0rk0o7.apps.googleusercontent.com&client_secret=nlZyrcPLg6oEwO9f9Wfn29Wh&refresh_token=1/xzt4kwzE1H7W9VnKB8cAaCx6zb4Es4nKEoqaYHdTD15IgOrJDtdun6zK6XiATCKT&grant_type=refresh_token").factory("externalLogging",["$http","$window","$q","$log","EXTERNAL_LOGGER_REFRESH_URL","EXTERNAL_LOGGER_SERVICE_URL","ENABLE_EXTERNAL_LOGGING",function(e,o,t,n,r,s,a){var i,c,u={},l=function(){var e=new Date,o=e.getUTCFullYear(),t=e.getUTCMonth()+1,n=e.getUTCDate();return t<10&&(t="0"+t),n<10&&(n="0"+n),o.toString()+t.toString()+n.toString()},m={kind:"bigquery#tableDataInsertAllRequest",skipInvalidRows:!1,ignoreUnknownValues:!1,templateSuffix:l(),rows:[{insertId:"",json:{event:"",event_details:"",event_value:0,host:"",ts:0,user_id:"",company_id:""}}]};return u.logEvent=function(r,i,c,l,d){if(n.debug("BQ log",r,i,c,l,d),a===!1)return void n.debug("External Logging DISABLED");var p=t.defer();return u.getToken().then(function(t){var a=JSON.parse(JSON.stringify(m)),u=s.replace("TABLE_ID","apps_events");a.rows[0].insertId=Math.random().toString(36).substr(2).toUpperCase(),a.rows[0].json.event=r,i&&(a.rows[0].json.event_details=i),c&&(a.rows[0].json.event_value=c),a.rows[0].json.user_id=l||"",a.rows[0].json.company_id=d||"",a.rows[0].json.host=o.location.hostname,a.rows[0].json.ts=(new Date).toISOString(),e.post(u,a,{headers:{"Content-Type":"application/json",Authorization:"Bearer "+t}}).then(function(e){p.resolve(e)},function(e){n.debug("error posting to BQ",e),p.reject(e)})},function(e){n.debug("BQ token ERROR",e),p.reject(e)}),p.promise},u.getToken=function(){var o=t.defer();return i&&(new Date).getTime()-c<358e4?o.resolve(i):e.post(r).then(function(e){i=e.data.access_token,c=(new Date).getTime(),o.resolve(e.data.access_token)},function(){o.reject()}),o.promise},u}]),function(e){"use strict";e.module("risevision.common.components.userstate").factory("googleAuthFactory",["$rootScope","$q","$log","$window","$stateParams","auth2APILoader","getOAuthUserInfo","uiFlowManager","userState","urlStateService",function(e,o,t,n,r,s,a,i,c,u){var l=function(){var e=o.defer();return s().then(function(o){var n=o.getAuthInstance()&&o.getAuthInstance().isSignedIn.get();t.debug("auth2.isSignedIn result:",n),n?e.resolve(n):e.reject("Failed to authorize user (auth2)")}).then(null,e.reject),e.promise},m=function(){var e=o.defer();return l().then(a).then(function(o){c._state.redirectState&&(u.redirectToState(c._state.redirectState),delete c._state.redirectState),e.resolve(o)}).then(null,function(o){e.reject(o)}),e.promise},d=function(){return c._state.inRVAFrame||n.self!==n.top},p=function(){var t,a=o.defer(),l=r.state;e.redirectToRoot===!1?(t=n.location.href.substr(0,n.location.href.indexOf("#"))||n.location.href,l=u.clearStatePath(l)):t=n.location.origin+"/",c._state.redirectState=l,c._persistState(),i.persist();var p={response_type:"token",prompt:"select_account",ux_mode:d()?"popup":"redirect",redirect_uri:t};return s().then(function(e){return e.getAuthInstance().signIn(p)}).then(function(){d()?a.resolve(m()):a.resolve()}).then(null,function(e){a.reject(e)}),a.promise},f={authenticate:function(e){return e?p():m()}};return f}])}(angular),function(e){"use strict";e.module("risevision.common.components.rvtokenstore").value("TOKEN_STORE_KEY","rv-auth-object").service("rvTokenStore",["$log","$location","cookieStore","getBaseDomain","TOKEN_STORE_KEY",function(e,o,t,n,r){var s=function(){var e=t.get(r);try{return JSON.parse(e)}catch(o){return e}},a=function(e){var o=n();"localhost"===o?t.put(r,JSON.stringify(e),{path:"/"}):t.put(r,JSON.stringify(e),{domain:o,path:"/"})},i=function(){var e=n();"localhost"===e?t.remove(r,{path:"/"}):t.remove(r,{domain:e,path:"/"})},c={read:s,write:a,clear:i};return c}])}(angular),function(e){"use strict";e.module("risevision.common.components.userstate").run(["$rootScope","userState","selectedCompanyUrlHandler",function(e,o,t){e.$on("risevision.company.selectedCompanyChanged",function(e){e&&t.updateUrl()}),e.$on("$stateChangeSuccess",t.updateSelectedCompanyFromUrl),e.$on("$routeChangeSuccess",t.updateSelectedCompanyFromUrl),e.$on("$locationChangeSuccess",t.locationChangeSuccess)}]).service("selectedCompanyUrlHandler",["$state","$stateParams","$location","userState",function(e,o,t,n){this.updateUrl=function(){var r=n.getSelectedCompanyId();r&&t.search().cid!==r&&!e.transition&&(o.cid=r,e.params.cid=r,t.search("cid",r))},this.updateSelectedCompanyFromUrl=function(){var r=t.search().cid;if(r&&n.getUserCompanyId()&&r!==n.getSelectedCompanyId())n.switchCompany(r);else if(!r&&n.getSelectedCompanyId()){var s=t.absUrl();o.cid=n.getSelectedCompanyId(),e.params.cid=n.getSelectedCompanyId(),t.search("cid",n.getSelectedCompanyId()),s===t.destUrl&&t.replace()}},this.locationChangeSuccess=function(e,o){t.destUrl=o}}])}(angular),function(e){"use strict";e.module("risevision.common.components.userstate").factory("urlStateService",["$window","$location","userState",function(e,o,t){var n={};n.get=function(){var o="",t={p:null,u:null,s:null};return t.p=e.location.pathname?e.location.pathname.substring(1):"",t.s=e.location.search,t.u=e.location.hash,(t.p||t.s||t.u)&&(o=encodeURIComponent(JSON.stringify(t))),o};var r=function(e){var o={};try{o=JSON.parse(decodeURIComponent(e))}catch(t){}return o};return n.redirectToState=function(n){var s=r(n);s.u||!o.$$html5?s.p||s.s?(t._persistState(),e.location.replace(s.p+s.s+s.u)):e.location.hash=s.u:(s.p=s.p||"/",s.s=s.s||"",o.url(s.p+s.s),o.replace())},n.clearStatePath=function(e){var o=r(e);return o.p=void 0,o.s=void 0,encodeURIComponent(JSON.stringify(o))},n.getUrlParam=function(e){if(o.search()[e])return o.search()[e];var t=decodeURIComponent(decodeURIComponent(decodeURIComponent(decodeURIComponent(o.path())))),n=new RegExp("[?&]"+e+'=([^&#"]*)').exec(t);return n&&n[1]},n}])}(angular),function(e){"use strict";e.module("risevision.common.components.userstate").value("FORCE_GOOGLE_AUTH",!1).factory("userAuthFactory",["$q","$log","$location","$rootScope","$loading","$window","$document","auth2APILoader","objectHelper","rvTokenStore","externalLogging","userState","googleAuthFactory","customAuthFactory","FORCE_GOOGLE_AUTH",function(o,t,n,r,s,a,i,c,u,l,m,d,p,f,g){var h,v,y=d._state,w=!0,b=function(e){if(w){w=!1;try{var o=(new Date).getTime()-a.performance.timing.navigationStart;m.logEvent("page load time",e,o,d.getUsername(),d.getSelectedCompanyId())}catch(n){t.debug("Error logging load time")}}},C=function(e){y.userToken=e,l.write(y.userToken)},S=function(){},$=function(){t.debug("Clearing user token..."),S(),y.userToken=null,l.clear(),d._resetState()},_=function(){var o=l.read();e.equals(o,y.userToken)?y.userToken&&(v=null,k(!1)["finally"](function(){y.userToken||(t.error("Authentication Failed. User no longer signed in."),a.location.reload())})):(t.error("Authentication Failed. User token no longer matches stored token."),a.location.reload())},R=function(){var e,o=i[0];"undefined"!=typeof o.hidden?e="visibilityState":"undefined"!=typeof o.mozHidden?e="mozVisibilityState":"undefined"!=typeof o.msHidden?e="msVisibilityState":"undefined"!=typeof o.webkitHidden&&(e="webkitVisibilityState"),t.debug("visibility: "+o[e]),"visible"===o[e]&&(_(),r.$broadcast("risevision.page.visible",!0))},P=function(){var e,o=i[0];return"undefined"!=typeof o.hidden?e="visibilitychange":"undefined"!=typeof o.mozHidden?e="mozvisibilitychange":"undefined"!=typeof o.msHidden?e="msvisibilitychange":"undefined"!=typeof o.webkitHidden&&(e="webkitvisibilitychange"),e},E=function(){document.addEventListener(P(),R)},A=function(){document.removeEventListener(P(),R)},U=function(e){var t=!1;return h?h.promise:e?y.user.username&&y.profile.username&&y.user.username===e.email?o.resolve():(h=o.defer(),u.clearAndCopy({userId:e.id,username:e.email,picture:e.picture},y.user),C(e),d.refreshProfile().then(null,function(e){if(e&&403!==e.code)return h.reject("Refresh Profile Error"),h=void 0,o.reject()}).then(function(){h.resolve(),r.$broadcast("risevision.user.authorized"),t||r.$broadcast("risevision.user.userSignedIn"),h=void 0}),h.promise):o.reject("No user")},k=function(e,n){var r,a=!1;if(e&&(v=null,$()),v)return v.promise;v=o.defer(),r=v,t.debug("authentication called");var i=function(){var o;n||y.userToken&&y.userToken.token&&!g?(a=!0,o=f.authenticate(n)):o=p.authenticate(e),o.then(U).then(function(){d._setIsRiseAuthUser(a),r.resolve()}).then(null,function(e){y.redirectDetected?(t.error("Authentication Error from Redirect: ",e),delete y.redirectDetected):t.debug("Authentication Error: ",e),$(),r.reject(e)})["finally"](function(){E(),s.stopGlobal("risevision.user.authenticate"),b("authenticated user")})};return c()["finally"](i),e&&s.startGlobal("risevision.user.authenticate"),r.promise},F=function(e){return c().then(function(o){d.isRiseAuthUser()||(e&&(a.logoutFrame.location="https://accounts.google.com/Logout"),o.getAuthInstance().signOut()),v=null,$(),r.$broadcast("risevision.user.signedOut"),t.debug("User is signed out.")})},q={authenticate:k,authenticatePopup:function(){return k(!0)},signOut:F,addEventListenerVisibilityAPI:E,removeEventListenerVisibilityAPI:A};return q}])}(angular),function(){"use strict";angular.module("risevision.common.components.userstate").service("userauth",["$q","$log","riseAPILoader",function(e,o,t){var n={add:function(n,r){var s=e.defer(),a={username:n,password:r};return t().then(function(e){return e.userauth.add(a)}).then(function(e){o.debug("added user credentials",e),s.resolve(e.result)}).then(null,function(e){console.error("Failed to add credentials.",e),s.reject(e)}),s.promise},updatePassword:function(n,r,s){var a=e.defer(),i={username:n,oldPassword:r,newPassword:s};return t().then(function(e){return e.userauth.updatePassword(i)}).then(function(e){o.debug("update user credentials resp",e),a.resolve(e.result)}).then(null,function(e){console.error("Failed to update credentials.",e),a.reject(e)}),a.promise},login:function(n,r){var s=e.defer(),a={username:n,password:r};return t().then(function(e){return e.userauth.login(a)}).then(function(e){o.debug("login successful",e),s.resolve(e)}).then(null,function(e){console.error("Failed to login user.",e),s.reject(e)}),s.promise},refreshToken:function(n,r){var s=e.defer(),a={username:n,token:r};return t().then(function(e){return e.userauth.refreshToken(a)}).then(function(e){o.debug("token refresh successful",e),s.resolve(e)}).then(null,function(e){console.error("Failed to refresh token.",e),s.reject(e)}),s.promise},confirmUserCreation:function(n,r){var s=e.defer(),a={username:n,userConfirmedToken:r};return t().then(function(e){return e.userauth.confirmUserCreation(a)}).then(function(e){o.debug("Confirm user creation successful",e),s.resolve(e)}).then(null,function(e){console.error("Failed to confirm user creation.",e),s.reject(e)}),s.promise},requestConfirmationEmail:function(n){var r=e.defer(),s={username:n};return t().then(function(e){return e.userauth.requestConfirmationEmail(s)}).then(function(e){o.debug("Request confirmation email successful",e),r.resolve(e)}).then(null,function(e){console.error("Failed to request confirmation email.",e),r.reject(e)}),r.promise},requestPasswordReset:function(n){var r=e.defer(),s={username:n};return t().then(function(e){return e.userauth.requestPasswordReset(s)}).then(function(e){o.debug("Request password reset successful",e),r.resolve(e)}).then(null,function(e){console.error("Failed to request password reset.",e),r.reject(e)}),r.promise},resetPassword:function(n,r,s){var a=e.defer(),i={username:n,passwordResetToken:r,newPassword:s};return t().then(function(e){return e.userauth.resetPassword(i)}).then(function(e){o.debug("Reset password successful",e),a.resolve(e)}).then(null,function(e){console.error("Failed to reset password.",e),a.reject(e)}),a.promise}};return n}])}(),function(e){"use strict";e.module("risevision.common.components.userstate").value("PROFILE_PICTURE_URL","https://www.gravatar.com/avatar/{emailMD5}?d=mm").factory("userState",["$q","$rootScope","$window","$log","$location","userInfoCache","getUserProfile","companyState","objectHelper","localStorageService","rvTokenStore","md5","PROFILE_PICTURE_URL",function(o,t,n,r,s,a,i,c,u,l,m,d,p){var f={profile:{},user:{},roleMap:{},userToken:m.read(),inRVAFrame:e.isDefined(s.search().inRVA),isRiseAuthUser:!1},g=function(){var e=o.defer();return i(f.user.username,!0).then(function(e){return $.updateUserProfile(e),c.init()}).then(function(){e.resolve()},e.reject),e.promise},h=function(){return!!f.user.username},v=function(){return null!==f.profile.username&&void 0!==f.profile.username},y=function(o){return e.isDefined(f.roleMap[o])},w=function(){return n.gapi&&n.gapi.auth?n.gapi.auth.getToken():null},b=function(){var o=l.get("risevision.common.userState");o&&(e.extend(f,o),l.remove("risevision.common.userState"),r.debug("userState restored with",o),f.redirectDetected=!0)},C=function(){a.removeAll(),u.clearObj(f.user),u.clearObj(f.profile),f.roleMap={},c.resetCompanyState(),r.debug("User state has been reset.")},S=function(){var e=$.getUsername()&&d.createHash($.getUsername()),o=e||"0";return p.replace("{emailMD5}",o)},$={getUsername:function(){return f.user&&f.user.username||null},getUserFullName:function(){var e=f.profile&&f.profile.firstName||"",o=f.profile&&f.profile.lastName||"";return(e+" "+o).trim()},getUserEmail:function(){return f.profile.email},getCopyOfProfile:function(o){return o?e.extend({},f.profile):u.follow(f.profile)},getUserPicture:function(){return f.user.picture||S()},hasRole:y,inRVAFrame:function(){return f.inRVAFrame},isRiseAdmin:function(){return y("sa")&&c.isRootCompany()},isRiseStoreAdmin:function(){return y("ba")&&c.isRootCompany()},isUserAdmin:function(){return y("ua")},isPurchaser:function(){return y("pu")},isRiseAuthUser:function(){return f.isRiseAuthUser},isSeller:c.isSeller,isRiseVisionUser:v,isLoggedIn:h,getAccessToken:w,checkUsername:function(e){return(e||!1)&&($.getUsername()||!1)&&e.toUpperCase()===$.getUsername().toUpperCase()},updateUserProfile:function(o){$.checkUsername(o.username)&&(u.clearAndCopy(e.extend({username:f.user.username},o),f.profile),f.roleMap={},f.profile.roles&&f.profile.roles.forEach(function(e){f.roleMap[e]=!0}),t.$broadcast("risevision.user.updated"))},refreshProfile:g,getUserCompanyId:c.getUserCompanyId,getUserCompanyName:c.getUserCompanyName,getSelectedCompanyId:c.getSelectedCompanyId,getSelectedCompanyName:c.getSelectedCompanyName,getSelectedCompanyCountry:c.getSelectedCompanyCountry,getCopyOfUserCompany:c.getCopyOfUserCompany,getCopyOfSelectedCompany:c.getCopyOfSelectedCompany,isSubcompanySelected:c.isSubcompanySelected,isTestCompanySelected:c.isTestCompanySelected,isRootCompany:c.isRootCompany,isSelectedCompanyChargebee:c.isSelectedCompanyChargebee,updateCompanySettings:c.updateCompanySettings,updateUserCompanySettings:c.updateUserCompanySettings,resetCompany:c.resetCompany,switchCompany:c.switchCompany,reloadSelectedCompany:c.reloadSelectedCompany,_restoreState:b,_resetState:C,_setUserToken:function(e){f.params=e,f.userToken="dummy"},_persistState:function(){l.set("risevision.common.userState",f)},_state:f,_setIsRiseAuthUser:function(e){f.isRiseAuthUser=e}};return $}])}(angular),angular.module("risevision.common.components.userstate").directive("confirmPasswordValidator",[function(){return{require:"ngModel",restrict:"A",scope:{confirmPasswordValidator:"="},link:function(e,o,t,n){var r=function(o){return o&&e.confirmPasswordValidator&&o!==e.confirmPasswordValidator?n.$setValidity("passwordMatch",!1):n.$setValidity("passwordMatch",!0),o};n.$parsers.unshift(r),n.$formatters.unshift(r)}}}]),angular.module("risevision.common.components.userstate").controller("ConfirmAccountCtrl",["$scope","$loading","$log","$state","$stateParams","userauth",function(e,o,t,n,r,s){o.startGlobal("auth-confirm-account"),s.confirmUserCreation(r.user,r.token).then(function(){t.log("User confirmed")})["catch"](function(e){console.error(e)})["finally"](function(){o.stopGlobal("auth-confirm-account"),n.go("common.auth.unauthorized",{accountConfirmed:!0})})}]),angular.module("risevision.common.components.userstate").controller("LoginCtrl",["$scope","$loading","$stateParams","$state","userAuthFactory","customAuthFactory","uiFlowManager","urlStateService","userState","FORCE_GOOGLE_AUTH",function(e,o,t,n,r,s,a,i,c,u){e.forms={},e.credentials={},e.messages={},e.errors={},e.FORCE_GOOGLE_AUTH=u,e.isSignUp=t.isSignUp,e.joinAccount=t.joinAccount,e.companyName=t.companyName,e.messages.passwordReset=t.passwordReset,e.messages.accountConfirmed=t.accountConfirmed,e.googleLogin=function(e){o.startGlobal("auth-buttons-login"),r.authenticate(!0)["finally"](function(){o.stopGlobal("auth-buttons-login"),a.invalidateStatus(e)})},e.customLogin=function(n){e.errors={},e.messages={},e.forms.loginForm.$valid&&(o.startGlobal("auth-buttons-login"),r.authenticate(!0,e.credentials).then(function(){i.redirectToState(t.state)})["catch"](function(o){400===o.status?e.messages.isGoogleAccount=!0:409===o.status?e.errors.unconfirmedError=!0:(console.error(o),e.errors.loginError=!0)})["finally"](function(){o.stopGlobal("auth-buttons-login"),a.invalidateStatus(n)}))},e.createAccount=function(t){e.errors={},e.messages={},e.forms.loginForm.$valid&&(o.startGlobal("auth-buttons-login"),s.addUser(e.credentials).then(function(){e.errors.confirmationRequired=!0}).then(null,function(){e.errors.duplicateError=!0})["finally"](function(){o.stopGlobal("auth-buttons-login"),a.invalidateStatus(t)}))}}]),angular.module("risevision.common.components.userstate").controller("RequestConfirmationEmailCtrl",["$scope","$loading","$log","userauth",function(e,o,t,n){e.forms={},e.credentials={},e.emailSent=!1,e.isGoogleAccount=!1,e.emailAlreadyConfirmed=!1,e.requestConfirmationEmail=function(){e.emailSent=!1,e.isGoogleAccount=!1,e.emailAlreadyConfirmed=!1,o.startGlobal("auth-request-confirmation-email"),n.requestConfirmationEmail(e.credentials.username).then(function(){t.log("Confirmation email request sent"),e.emailSent=!0})["catch"](function(o){400===o.status?(t.log("Requested confirmation email for Google account"),e.isGoogleAccount=!0):409===o.status?(t.log("Requested confirmation email for already confirmed account"),e.emailAlreadyConfirmed=!0):(console.error(o),e.emailSent=!0)})["finally"](function(){o.stopGlobal("auth-request-confirmation-email")})}}]),angular.module("risevision.common.components.userstate").controller("RequestPasswordResetCtrl",["$scope","$loading","$log","userauth",function(e,o,t,n){e.forms={},e.credentials={},e.errors={},e.emailSent=!1,e.isGoogleAccount=!1,e.requestPasswordReset=function(){e.emailSent=!1,e.isGoogleAccount=!1,o.startGlobal("auth-request-password-reset"),n.requestPasswordReset(e.credentials.username).then(function(){t.log("Reset password request sent"),e.emailSent=!0})["catch"](function(o){400===o.status?(t.log("Requested password reset for Google account"),e.isGoogleAccount=!0):(console.error(o),e.emailSent=!0)})["finally"](function(){o.stopGlobal("auth-request-password-reset")})}}]),angular.module("risevision.common.components.userstate").controller("ResetPasswordConfirmCtrl",["$scope","$loading","$log","$state","$stateParams","userauth",function(e,o,t,n,r,s){function a(){e.emailResetSent=!1,e.invalidToken=!1}e.forms={},e.credentials={},e.errors={},e.resetPassword=function(){a(),e.forms.resetPasswordForm.$valid&&(o.startGlobal("auth-reset-password"),s.resetPassword(r.user,r.token,e.credentials.newPassword).then(function(){t.log("Password updated"),n.go("common.auth.unauthorized",{passwordReset:!0})})["catch"](function(o){var t=o.result&&o.result.error&&o.result.error.message;"Password reset token does not match"===t?e.invalidToken=!0:console.error(o)})["finally"](function(){o.stopGlobal("auth-reset-password")}))},e.requestPasswordReset=function(){a(),o.startGlobal("auth-request-password-reset"),s.requestPasswordReset(r.user).then(function(){t.log("Email sent"),e.emailResetSent=!0})["catch"](function(e){console.error(e)})["finally"](function(){o.stopGlobal("auth-request-password-reset")})}}]),function(e){try{e=angular.module("risevision.common.components.userstate")}catch(o){e=angular.module("risevision.common.components.userstate",[])}e.run(["$templateCache",function(e){e.put("userstate/auth-common.html",'<div class="app-launcher-login"><div class="container"><div class="panel"><div class="row"><div class="col-sm-6 col-xs-12"><div class="rise-logo"><img src="https://s3.amazonaws.com/Rise-Images/Website/rise-logo.svg"></div></div><div class="col-sm-6 col-xs-12"><div ui-view=""></div></div></div></div></div></div>')}])}(),function(e){try{e=angular.module("risevision.common.components.userstate")}catch(o){e=angular.module("risevision.common.components.userstate",[])}e.run(["$templateCache",function(e){e.put("userstate/auth-form.html",'<form id="forms.loginForm" name="forms.loginForm" role="form" novalidate=""><div><div class="panel-body bg-danger u_margin-sm-top" ng-show="errors.duplicateError"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span id="already-registered-warning">This email address is already registered. You can <a ui-sref="common.auth.unauthorized">sign in</a> with this address.</span></p></div><div class="panel-body bg-danger u_margin-sm-top" ng-show="errors.loginError"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span id="incorrect-credentials-error">Your email address/password combination is incorrect.<br>If you are having problems signing in, please check this <a href="https://help.risevision.com/hc/en-us/articles/115001402743-I-am-having-trouble-logging-in-what-can-I-do-" target="_blank">Help Center article</a>.</span></p></div><div class="panel-body bg-info u_margin-sm-top" ng-show="errors.unconfirmedError"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span>Your email address has not been confirmed.<br><a ui-sref="common.auth.requestconfirmationemail">Resend Email Confirmation</a></span></p></div><div class="panel-body bg-info u_margin-sm-top" ng-show="errors.confirmationRequired"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span>We\'ve sent a confirmation email to {{credentials.username}}.<br>Please check your inbox to complete your account registration.</span></p></div><div class="panel-body bg-info u_margin-sm-top" ng-show="messages.passwordReset"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span>Password successfully updated.<br>Please sign in to proceed.</span></p></div><div class="panel-body bg-info u_margin-sm-top" ng-show="messages.accountConfirmed"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span>Account successfully confirmed.<br>Please sign in to proceed.</span></p></div><div class="panel-body bg-danger u_margin-sm-top" ng-show="messages.isGoogleAccount"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span>This account is authenticated by Google.<br>Please, use the \'Sign in with Google\' button.</span></p></div></div><div class="u_margin-sm-top" ng-show="!errors.confirmationRequired"><div class="form-group" ng-class="{\'has-error\': (forms.loginForm.$submitted && forms.loginForm.username.$invalid)}" show-errors=""><label class="control-label">Email</label> <input type="email" class="form-control" placeholder="Enter Your Email Address" id="username" name="username" ng-model="credentials.username" required="" focus-me="true" autocomplete="email"><p class="text-danger" ng-show="forms.loginForm.$submitted && forms.loginForm.username.$invalid">Please enter an Email</p></div><div class="form-group" ng-class="{\'has-error\': (forms.loginForm.$submitted && forms.loginForm.password.$invalid && isSignUp), \'has-message\': forms.loginForm.password.$valid && isSignUp}" show-errors=""><label class="control-label">{{ isSignUp ? \'Create \' : \'\'}}Password</label> <input type="password" class="form-control" placeholder="Enter Password" id="password" name="password" ng-model="credentials.password" required="" minlength="4"><p class="text-danger" ng-show="forms.loginForm.$submitted && forms.loginForm.password.$error.minlength && isSignUp">New Password must be at least 4 characters long.</p><p class="text-warning" ng-show="forms.loginForm.password.$valid && isSignUp">A strong password is at least 8 characters, includes uppercase/lowercase letters, and one or more numbers.</p></div><div class="form-group" ng-class="{ \'has-error\' : (forms.loginForm.$submitted && forms.loginForm.confirmPassword.$invalid) }" ng-if="isSignUp"><label class="control-label" for="confirm-password">Confirm Password</label> <input id="confirmPassword" type="password" name="confirmPassword" class="form-control" placeholder="Re-type Password" ng-model="credentials.confirmPassword" required="" confirm-password-validator="credentials.password"><p ng-show="forms.loginForm.$submitted && forms.loginForm.confirmPassword.$error.required" class="text-danger">Confirm Password is required.</p><p ng-show="forms.loginForm.$submitted && forms.loginForm.confirmPassword.$error.passwordMatch" class="text-danger">New Password and Confirm Password must match.</p></div></div></form>');
}])}(),function(e){try{e=angular.module("risevision.common.components.userstate")}catch(o){e=angular.module("risevision.common.components.userstate",[])}e.run(["$templateCache",function(e){e.put("userstate/create-account.html",'<div ng-if="!joinAccount"><h1 class="u_remove-top">Get Started For Free</h1><p class="lead text-muted">No credit card or commitment required.</p></div><div ng-if="joinAccount"><h1 class="u_remove-top">Join Your Company</h1><p class="lead text-muted">Complete your account <span ng-if="!companyName">registration</span><span ng-if="companyName">with {{companyName}}</span>.</p></div><div class="col-xs-12 col-md-8" ng-show="!errors.confirmationRequired"><button class="btn btn-google-auth btn-hg" id="sign-up-google-link" ng-click="googleLogin(\'registrationComplete\')"><span><img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg"> Sign up with Google</span></button></div><div class="section-divider col-xs-12 col-md-8 u_margin-md-top" ng-show="!errors.confirmationRequired" ng-if="!FORCE_GOOGLE_AUTH"><div></div><span>OR</span><div></div></div><div class="col-md-8 col-xs-12" ng-if="!FORCE_GOOGLE_AUTH"><div ng-include="\'userstate/auth-form.html\'"></div><div class="form-group" ng-show="!errors.confirmationRequired"><button id="sign-up-button" class="btn btn-primary btn-hg" type="submit" form="forms.loginForm" ng-click="createAccount(\'registrationComplete\')"><span translate="Sign Up"></span></button></div></div><br><div class="col-xs-12 u_margin-lg-top"><p class="text-muted">Already have an account? <a id="sign-in-link" ui-sref="common.auth.unauthorized">Sign in</a></p></div>')}])}(),function(e){try{e=angular.module("risevision.common.components.userstate")}catch(o){e=angular.module("risevision.common.components.userstate",[])}e.run(["$templateCache",function(e){e.put("userstate/login.html",'<h1 class="u_remove-top">Sign In</h1><p class="lead text-muted">to your Rise Vision account</p><div class="col-xs-12 col-md-8"><button class="btn btn-google-auth btn-hg" id="sign-in-google-link" ng-click="googleLogin(\'registrationComplete\')"><span><img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg"> Sign in with Google</span></button></div><div class="section-divider col-xs-12 col-md-8 u_margin-md-top" ng-if="!FORCE_GOOGLE_AUTH"><div></div><span>OR</span><div></div></div><div class="col-md-8 col-xs-12" ng-if="!FORCE_GOOGLE_AUTH"><div ng-include="\'userstate/auth-form.html\'"></div><div class="form-group"><button id="sign-in-button" class="btn btn-primary btn-hg" type="submit" form="forms.loginForm" ng-click="customLogin(\'registrationComplete\')"><span translate="Sign In"></span></button></div></div><br><div class="col-xs-12 u_margin-lg-top"><p class="text-muted" ng-if="!FORCE_GOOGLE_AUTH"><a id="reset-password-link" ui-sref="common.auth.requestpasswordreset">Forgot your password?</a></p><p class="text-muted">Don\'t have an account? <a id="sign-up-link" ui-sref="common.auth.createaccount">Sign up</a></p></div>')}])}(),function(e){try{e=angular.module("risevision.common.components.userstate")}catch(o){e=angular.module("risevision.common.components.userstate",[])}e.run(["$templateCache",function(e){e.put("userstate/request-confirmation-email.html",'<h1 class="u_remove-top">Send Confirmation Email</h1><div class="col-xs-12 col-md-8"><div class="panel-body bg-info u_margin-lg-top" ng-show="emailSent"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span>We\'ve sent a confirmation email to {{credentials.username}}.<br>Please check your inbox to complete your account registration.<br></span></p></div><div class="panel-body bg-info u_margin-lg-top" ng-show="emailAlreadyConfirmed"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span>The {{credentials.username}} account is already confirmed.</span></p></div><div class="panel-body bg-danger u_margin-lg-top" ng-show="isGoogleAccount"><p class="u_remove-bottom"><span><i class="fa fa-warning icon-left"></i> This account is authenticated by Google.<br><p class="text-muted">You can <a id="sign-in-link" ui-sref="common.auth.unauthorized">Sign in with Google</a> in our login page.</p></span></p></div></div><form id="confirmationEmailForm" role="form" name="forms.confirmationEmailForm" novalidate="" ng-show="!emailSent"><div class="col-md-8 col-xs-12 u_margin-md-top"><div class="form-group" ng-class="{\'has-error\': (forms.confirmationEmailForm.$submitted && forms.confirmationEmailForm.username.$invalid)}" show-errors=""><label class="control-label">Email</label> <input type="text" class="form-control" name="username" ng-model="credentials.username" required="" focus-me="true"><p class="text-danger" ng-show="forms.confirmationEmailForm.$submitted && forms.confirmationEmailForm.username.$invalid">Please enter an Email</p></div><button class="btn btn-primary btn-hg" ng-disabled="forms.confirmationEmailForm.$invalid" ng-click="requestConfirmationEmail()">Send Confirmation Email</button></div></form><br><div class="col-xs-12 u_margin-lg-top"><p class="text-muted"><a id="sign-in-link" ui-sref="common.auth.unauthorized">Sign in</a> to your account instead.</p></div>')}])}(),function(e){try{e=angular.module("risevision.common.components.userstate")}catch(o){e=angular.module("risevision.common.components.userstate",[])}e.run(["$templateCache",function(e){e.put("userstate/request-password-reset.html",'<h1 class="u_remove-top">Password Reset</h1><div class="col-xs-12 col-md-8"><div class="panel-body bg-info u_margin-lg-top" ng-show="emailSent"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span>An email with password reset instructions has been sent to your email inbox (if it exists in our system).</span></p></div><div class="panel-body bg-danger u_margin-lg-top" ng-show="isGoogleAccount"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span>This account is authenticated by Google.<br><a href="https://myaccount.google.com/security#signin" target="_blank">Change your password on your Google account.</a></span></p></div></div><form id="requestResetForm" role="form" name="forms.requestResetForm" novalidate="" ng-show="!emailSent"><div class="col-md-8 col-xs-12 u_margin-md-top"><div class="form-group" ng-class="{\'has-error\': (forms.requestResetForm.$submitted && forms.requestResetForm.username.$invalid)}" show-errors=""><label class="control-label">Email</label> <input type="text" class="form-control" name="username" ng-model="credentials.username" required="" focus-me="true"><p class="text-danger" ng-show="forms.requestResetForm.$submitted && forms.requestResetForm.username.$invalid">Please enter an Email</p></div><button class="btn btn-primary btn-hg" ng-disabled="forms.requestResetForm.$invalid" ng-click="requestPasswordReset()">Reset Password</button></div></form><br><div class="col-xs-12 u_margin-lg-top"><p class="text-muted"><a id="sign-in-link" ui-sref="common.auth.unauthorized">Sign in</a> to your account instead.</p></div>')}])}(),function(e){try{e=angular.module("risevision.common.components.userstate")}catch(o){e=angular.module("risevision.common.components.userstate",[])}e.run(["$templateCache",function(e){e.put("userstate/reset-password-confirm.html",'<h1 class="u_remove-top">Password Confirmation</h1><div><div class="panel-body bg-info u_margin-lg-top" ng-show="emailResetSent"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span>An email with password reset instructions has been sent to your email inbox.</span></p></div><div class="panel-body bg-danger u_margin-lg-top" ng-show="invalidToken"><p class="u_remove-bottom"><i class="fa fa-warning icon-left"></i> <span>The password reset token is not valid. <a href="#" ng-click="requestPasswordReset()">Request Password Reset</a></span></p></div></div><form id="forms.resetPasswordForm" role="form" name="forms.resetPasswordForm" novalidate="" ng-show="!emailResetSent"><div class="col-md-8 col-xs-12 u_margin-md-top"><div class="form-group" ng-class="{\'has-error\': (forms.resetPasswordForm.$submitted && forms.resetPasswordForm.newPassword.$invalid)}" show-errors=""><label class="control-label">New Password</label> <input type="password" class="form-control" name="newPassword" id="newPassword" ng-model="credentials.newPassword" required="" minlength="4" focus-me="true"><p class="text-danger" ng-show="forms.resetPasswordForm.$submitted && forms.resetPasswordForm.newPassword.$error.minlength">New Password must be at least 4 characters long.</p><p class="text-warning" ng-show="forms.resetPasswordForm.newPassword.$valid">A strong password is at least 8 characters, includes uppercase/lowercase letters, and one or more numbers.</p></div><div class="form-group" ng-class="{\'has-error\': (forms.resetPasswordForm.$submitted && forms.resetPasswordForm.confirmPassword.$invalid)}" show-errors=""><label class="control-label">Confirm Password</label> <input type="password" class="form-control" name="confirmPassword" id="confirmPassword" ng-model="credentials.confirmPassword" required="" confirm-password-validator="credentials.newPassword"><p ng-show="forms.resetPasswordForm.$submitted && forms.resetPasswordForm.confirmPassword.$error.required" class="text-danger">Confirm Password is required.</p><p ng-show="forms.resetPasswordForm.$submitted && forms.resetPasswordForm.confirmPassword.$error.passwordMatch" class="text-danger">New Password and Confirm Password must match.</p></div><button id="resetPasswordButton" type="submit" form="forms.resetPasswordForm" class="btn btn-primary btn-hg" ng-click="resetPassword()">Update Password</button></div></form>')}])}(),function(e){try{e=angular.module("risevision.common.components.userstate")}catch(o){e=angular.module("risevision.common.components.userstate",[])}e.run(["$templateCache",function(e){e.put("userstate/unsubscribe.html",'<div class="alert alert-warning col-xs-12 u_margin-md-top"><strong>{{email}}</strong> has been unsubscribed from monitoring the Display <strong>\'{{name}}\'</strong>. (Display ID: {{id}})</div><a id="reset-password-link" href="/">Sign in to your Rise Vision account</a><p></p>')}])}();