"use strict";angular.module("risevision.common.components.ui-flow",["LocalStorageModule"]).constant("uiStatusDependencies",{_dependencies:{},_retries:{},addDependencies:function(e){angular.extend(this._dependencies,e)},setMaximumRetryCount:function(e,t){if(t<1)throw"Retry count for "+e+" must be equal to or greater than 1.";void 0===this._retries[e]&&(this._retries[e]=t)}}),angular.module("risevision.common.components.ui-flow").factory("uiFlowManager",["$log","$q","$injector","uiStatusDependencies","$rootScope","localStorageService",function(e,t,n,i,r,s){var o,a,u,c=null,d=i._dependencies,f=function(){return function(){var e=t.defer();return e.resolve(!0),e.promise}},l=function(t){var i;try{i=n.get(t)}catch(r){e.debug("Generating dummy status",t),i=f()}return i},g=function(n){var i;e.debug("Attempting to reach status",n,"...");var r=d[n];if(r){r instanceof Array||(r=[r]);var s=t.defer(),o=s;angular.forEach(r,function(r){var o=t.defer();s.promise.then(o.resolve,function(){g(r).then(function(){d[r]&&e.debug("Deps for status",r,"satisfied."),l(n)().then(function(){e.debug("Status",n,"satisfied."),o.resolve(!0)},function(){e.debug("Status",n,"not satisfied."),o.reject(n)})},function(t){d[r]?(e.debug("Failed to reach status",r," because its dependencies are not satisfied. Last rejected dep: ",t),o.reject(t)):o.reject(r)})}),i=s=o}),o.reject()}else i=t.defer(),l(n)().then(function(){e.debug("Termination status",n,"satisfied."),i.resolve(!0)},function(){e.debug("Termination status",n,"not satisfied."),i.reject(n)});return i.promise},v=!0,m=function(n){if(!n&&!a){var r=t.defer();return r.resolve(),r.promise}return!a&&v&&(a=n,c=angular.copy(i._retries),u=t.defer(),v=!1),a&&(u=t.defer(),g(a).then(function(e){a&&(o=a),u.resolve(e),a=null,v=!0},function(t){o=t,void 0!==c[t]&&(0===c[t]?(e.debug("Maximum allowed retries for status",t,"reached. Validation will cancel."),S()):c[t]--),v=!0,u.reject(t)})),u&&u.promise},p=function(e){return o="pendingCheck",m(e)},h=function(){s.set("risevision.ui-flow.state",{goalStatus:a,retriesLeft:c})},S=function(){o="",a="",c=null,v=!0,r.$broadcast("risevision.uiStatus.validationCancelled"),e.debug("UI status validation cancelled.")};if(s.get("risevision.ui-flow.state")){var b=s.get("risevision.ui-flow.state");b&&b.goalStatus&&(a=b.goalStatus,e.debug("uiFlowManager.goalStatus restored to",b.goalStatus,b.retriesLeft),c=b.retriesLeft,u=t.defer(),v=!1),s.remove("risevision.ui-flow.state")}var w={invalidateStatus:p,cancelValidation:S,getStatus:function(){return o},isStatusUndetermined:function(){return"pendingCheck"===o},persist:h};return w}]);