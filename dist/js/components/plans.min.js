"use strict";angular.module("risevision.common.components.plans.services",["risevision.store.authorization","risevision.common.gapi","risevision.common.currency"]),angular.module("risevision.common.components.plans",["risevision.common.components.plans.services","risevision.common.components.scrolling-list","risevision.common.components.loading","ui.bootstrap"]),function(e){e.module("risevision.common.currency",["risevision.common.gapi"]).factory("currencyService",["$q","storeAPILoader","$log",function(e,n,t){var r=null,a={defaultItem:null},i=function(e){this.country=e.country,this.currencyCode=e.currencyCode,this.description=e.description,this.bankAccountCode=e.bankAccountCode,this.bankAccountDescription=e.bankAccountDescription,this.getName=function(){return this.currencyCode.toUpperCase()},this.pickPrice=function(e,n){switch(this.currencyCode.toUpperCase()){case"CAD":return n;default:return e}}};return a.getByCountry=function(e){if(e)for(var n=0;n<this.items.length;n++)if(this.items[n].country&&this.items[n].country.toUpperCase()===e.toUpperCase())return this.items[n];return this.defaultItem},a.setItems=function(e){this.items=[];for(var n=0;n<e.length;n++){var t=new i(e[n]);this.items.push(t),t.country||(this.defaultItem=t)}},function(){return null!==r?r.promise:(r=e.defer(),t.debug("currencyService called"),n().then(function(e){var n=e.currency.list();n.execute(function(e){t.debug("currencyService resp",e),e.error?(console.error("currencyService error: ",e.error),r.reject(e.error)):(a.setItems(e.items),r.resolve(a))})}),r.promise)}}])}(angular),function(e){e.module("risevision.common.components.plans").value("PLANS_LIST",[{name:"Free",type:"free",productId:"000",productCode:"000",status:"Active",priceMonth:0,descriptionShort:"Design, distribute and manage your digital signage for free. Unlimited Displays, Companies and Users.",proLicenseCount:0},{name:"Basic",type:"basic",productId:"289",productCode:"40c092161f547f8f72c9f173cd8eebcb9ca5dd25",proLicenseCount:2,trialPeriod:14},{name:"Advanced",type:"advanced",productId:"290",productCode:"93b5595f0d7e4c04a3baba1102ffaecb17607bf4",proLicenseCount:9,trialPeriod:14},{name:"Enterprise",type:"enterprise",productId:"301",productCode:"b1844725d63fde197f5125b58b6cba6260ee7a57",proLicenseCount:50},{name:"Enterprise",type:"enterprisesub",productId:"303",productCode:"d521f5bfbc1eef109481eebb79831e11c7804ad8",proLicenseCount:0}]).factory("planFactory",["$q","$log","$rootScope","$modal","$templateCache","userState","storeAPILoader","currencyService","subscriptionStatusService","storeAuthorization","PLANS_LIST",function(e,n,t,r,a,i,o,s,c,l,u){function p(){return s().then(function(e){var n=i.getCopyOfSelectedCompany(),t=n&&n.country?n.country:"";return e.getByCountry(t)})}function d(){var e=i.getCopyOfSelectedCompany(),r=null;e.id&&e.planProductCode?(r=_.cloneDeep(f[e.planProductCode]),r.status=e.planSubscriptionStatus,r.trialPeriod=e.planTrialPeriod,r.proStatus=e.playerProSubscriptionStatus,r.planPlayerProLicenseCount=e.planPlayerProLicenseCount,r.playerProLicenseCount=e.playerProLicenseCount):r=_.cloneDeep(g.free),m.currentPlan=r,n.debug("Current plan",r),t.$emit("risevision.plan.loaded",r)}var m={},b=_.map(u,"productCode"),g=_.keyBy(u,"type"),f=_.keyBy(u,"productCode");return m.getPlans=function(t){n.debug("getPlans called.");var r=e.defer();return o().then(function(e){e.product.list(t).execute(function(e){n.debug("getPlans response",e),e.error?r.reject(e.error):r.resolve(e)})}),r.promise},m.getPlansDetails=function(){n.debug("getPlansDetails called.");var t=e.defer(),r="(productTag=Plans)";return m.getPlans({search:r}).then(function(e){return n.debug("getPlansDetails response.",e),p().then(function(n){e.items.forEach(function(e){var t="per Company per Month",r=_.keyBy(e.pricing,"unit"),a=r[t]||{};e.name=e.name.replace(" Plan",""),e.type=e.name.toLowerCase(),e.priceMonth=n.pickPrice(a.priceUSD,a.priceCAD)});var r=_.keyBy(e.items,"type");t.resolve([_.cloneDeep(g.free),r.basic,r.advanced,r.enterprise])})})["catch"](function(e){t.reject(e)}),t.promise},m.showPlansModal=function(e){r.open({template:a.get("plans/plans-modal.html"),controller:"PlansModalCtrl",size:"lg",resolve:{currentPlan:function(){return m.currentPlan},showRPPLink:function(){return e}}})},m.getCompanyPlanStatus=function(){n.debug("getCompanyPlanStatus called.");var t=e.defer();return c.list(b.slice(1),i.getSelectedCompanyId()).then(function(e){n.debug("getCompanyPlanStatus response.",e);var r=_.keyBy(e,"pc");t.resolve(r)})["catch"](function(e){t.reject(e)}),t.promise},m.getProLicenseCount=function(){var e=m.isSubscribed()||m.isOnTrial(),n=e&&m.currentPlan.planPlayerProLicenseCount||0,t=m.isProSubscribed()&&m.currentPlan.playerProLicenseCount||0;return n+t},m.areAllProLicensesUsed=function(){var e=i.getCopyOfSelectedCompany(),n=m.getProLicenseCount(),t=e.playerProAssignedDisplays||[];return t.length>=n},m.toggleDisplayLicenseLocal=function(e,n){var t=i.getCopyOfSelectedCompany(!0),r=t.playerProAssignedDisplays||[];n&&r.indexOf(e)===-1?r.push(e):!n&&r.indexOf(e)>=0&&r.splice(r.indexOf(e),1),t.playerProAssignedDisplays=r,i.updateCompanySettings(t)},m.startTrial=function(e){return l.startTrial(e.productCode).then(function(){var n=i.getCopyOfSelectedCompany(!0);n.planProductCode=e.productCode,n.planTrialPeriod=e.trialPeriod,n.planSubscriptionStatus="Trial",n.planPlayerProLicenseCount=f[e.productCode].proLicenseCount,i.updateCompanySettings(n)})["catch"](function(e){throw n.debug("Failed to start trial",e),e})},m.startBasicPlanTrial=function(){return m.startTrial(g.basic)},m.isPlanActive=function(){return m.isSubscribed()||m.isOnTrial()},m.isFree=function(){return"free"===m.currentPlan.type},m.isEnterpriseSubCompany=function(){return"enterprisesub"===m.currentPlan.type},m.isSubscribed=function(){return!m.isFree()&&"Active"===m.currentPlan.status},m.isOnTrial=function(){return!m.isFree()&&"Trial"===m.currentPlan.status},m.isTrialExpired=function(){return!m.isFree()&&"Trial Expired"===m.currentPlan.status},m.isSuspended=function(){return!m.isFree()&&"Suspended"===m.currentPlan.status},m.isProSubscribed=function(){return"Active"===m.currentPlan.proStatus},m.isProSuspended=function(){return"Suspended"===m.currentPlan.proStatus},m.hasProfessionalLicenses=function(){return m.isSubscribed()||m.isOnTrial()||m.isProSubscribed()},d(),t.$on("risevision.company.selectedCompanyChanged",function(){d()}),t.$on("risevision.company.updated",function(){d()}),m}])}(angular),angular.module("risevision.common.components.plans").controller("PlansDowngradeModalCtrl",["$scope","$modalInstance",function(e,n){e.dismiss=function(){n.dismiss("cancel")}}]),angular.module("risevision.common.components.plans").controller("PlansModalCtrl",["$scope","$rootScope","$modalInstance","$log","$modal","$templateCache","$loading","$timeout","$q","planFactory","currentPlan","showRPPLink","userState",function(e,n,t,r,a,i,o,s,c,l,u,p,d){function m(){return o.start("plans-modal"),c.all([l.getCompanyPlanStatus(),l.getPlansDetails()]).then(function(n){var t=n[0];e.plans=n[1],e.plans.forEach(function(e){var n=t[e.productCode]||e;e.status=n.status,e.statusCode=n.statusCode})})["catch"](function(e){r.debug("Failed to load plans",e)})["finally"](function(){o.stop("plans-modal")})}var b=d.getCopyOfSelectedCompany();e.currentPlan=u,e.startTrialError=null,e.showRPPLink=p,e.playerProSubscriptionId=b.playerProSubscriptionId,e.companyId=b.id,e.showDowngradeModal=function(){a.open({template:i.get("plans/plans-downgrade-modal.html"),controller:"PlansDowngradeModalCtrl",size:"md"})},e.isCurrentPlan=function(e){return u.type===e.type},e.isOnTrial=function(e){return"on-trial"===e.statusCode},e.isTrialAvailable=function(e){return"trial-available"===e.statusCode},e.isTrialExpired=function(e){return"trial-expired"===e.statusCode},e.isSubscribed=function(e){return"Subscribed"===e.status||"Active"===e.status},e.isFree=function(e){return"free"===e.type},e.currentButtonVisible=function(n){var t=e.isFree(n)&&l.isTrialExpired(),r=e.isCurrentPlan(n)&&e.isSubscribed(n);return t||r},e.subscribeButtonVisible=function(n){return e.isOnTrial(n)||e.isTrialExpired(n)||e.canUpgrade(n)},e.proSubscriptionLinkVisible=function(){return e.playerProSubscriptionId&&(l.isProSubscribed()||l.isProSuspended())},e.canUpgrade=function(n){return!e.canStartTrial(n)&&(u.type!==n.type&&("enterprise"!==u.type&&("advanced"===u.type&&"enterprise"===n.type||("basic"===u.type&&("advanced"===n.type||"enterprise"===n.type)||"free"===u.type))))},e.canDowngrade=function(n){return!e.canStartTrial(n)&&!e.isOnTrial(n)&&((!e.isFree(n)||!l.isTrialExpired())&&(u.type!==n.type&&("enterprise"===u.type||("advanced"===u.type&&("free"===n.type||"basic"===n.type)||"basic"===u.type&&"free"===n.type))))},e.canStartTrial=function(n){return"Active"!==u.planSubscriptionStatus&&(u.type!==n.type&&e.isTrialAvailable(n))},e.startTrial=function(a){o.start("plans-modal"),e.startTrialError=null,l.startTrial(a).then(function(){return s(5e3).then(function(){return d.reloadSelectedCompany()}).then(function(){n.$emit("risevision.company.trial.started")})["catch"](function(e){r.debug("Failed to reload company",e)})["finally"](function(){t.close(a)})})["catch"](function(n){e.startTrialError=n})["finally"](function(){o.stop("plans-modal")})},e.dismiss=function(){t.dismiss("cancel")},e.init=function(){m()},e.init()}]),function(e){try{e=angular.module("risevision.common.components.plans")}catch(n){e=angular.module("risevision.common.components.plans",[])}e.run(["$templateCache",function(e){e.put("plans/plans-downgrade-modal.html",'<div><div class="modal-header"><button type="button" class="close" ng-click="dismiss()" aria-hidden="true"><i class="fa fa-times"></i></button><h3 id="icpModalTitle" class="modal-title">Downgrade</h3></div><div class="modal-body u_padding-lg" stop-event="touchend"><div class="container-fluid text-center u_padding-lg">Downgrading an account needs to be processed through our Support team. Please reach out and we\'ll help!<br><a class="btn btn-primary btn-lg u_margin-lg-top" href="https://www.risevision.com/contact-us" target="_blank">Contact Us</a></div></div><div class="modal-footer"></div></div>')}])}(),function(e){try{e=angular.module("risevision.common.components.plans")}catch(n){e=angular.module("risevision.common.components.plans",[])}e.run(["$templateCache",function(e){e.put("plans/plans-modal.html",'<div rv-spinner="" rv-spinner-key="plans-modal" rv-spinner-start-active="1"><div class="modal-header"><button type="button" class="close" ng-click="dismiss()" aria-hidden="true"><i class="fa fa-times"></i></button><h3 class="modal-title" translate="">common-header.plans.choose-plan</h3></div><div id="plans-modal" class="modal-body u_padding-lg" stop-event="touchend"><div ng-show="startTrialError" class="alert alert-danger u_margin-xs-bottom" translate="">common-header.plans.error-starting-trial</div><div class="grid-list row"><div class="col-xs-12 col-sm-6 col-md-3" ng-repeat="plan in plans"><div class="u_cursor_disabled panel panel-default"><div itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb"><div class="grid-list-text text-center"><h4 id="productName">{{plan.name}}</h4><p class="product-description">{{plan.descriptionShort}}</p><div><h1>${{plan.priceMonth}}</h1>&nbsp;<span translate="">common-header.plans.per-company-month</span></div><div class="u_margin-lg"><p class="small u_margin-sm-bottom" ng-show="!isOnTrial(plan) && !isTrialExpired(plan)">&nbsp;</p><p id="trial-days-remaining" class="small u_margin-sm-bottom" ng-show="isCurrentPlan(plan) && isOnTrial(plan)" translate="" translate-values="{ count: currentPlan.trialPeriod }">common-header.plans.days-left-trial</p><p class="small u_margin-sm-bottom text-danger" ng-show="isCurrentPlan(plan) && isTrialExpired(plan)" translate="">common-header.plans.trial-expired</p><a id="current-plan" ng-show="currentButtonVisible(plan)" target="_blank" class="cta_button btn btn-white" translate="">common-header.plans.current</a><a id="subscribe-plan" ng-show="subscribeButtonVisible(plan)" target="_blank" href="https://store.risevision.com/product/{{plan.productId}}" class="cta_button btn btn-primary" translate="">common-header.plans.subscribe</a><a id="start-trial-plan" ng-show="canStartTrial(plan)" target="_blank" ng-click="startTrial(plan)" class="cta_button btn btn-primary" translate="">common-header.plans.start-trial</a><a id="downgrade-plan" ng-show="canDowngrade(plan)" ng-click="showDowngradeModal()" class="cta_button btn btn-default" translate="">common-header.plans.downgrade</a></div></div></div></div></div></div><div ng-show="!showRPPLink" class="text-center u_margin-md-top"><a class="btn btn-link btn-lg get-started-guide" target="_blank" href="https://www.risevision.com/pricing?utm_campaign=apps" translate="">common-header.plans.learn-more-1</a> <span class="bold" translate="">common-header.plans.learn-more-2</span> <a class="btn btn-link btn-lg get-started-guide" target="_blank" href="https://www.risevision.com/contact-us" translate="">common-header.plans.learn-more-3</a></div><div ng-show="showRPPLink && !proSubscriptionLinkVisible()" class="text-center u_margin-md-top"><a class="btn btn-link btn-lg" target="_blank" href="https://store.risevision.com/product/2048" link-cid="" translate="">common-header.plans.individual-licenses</a> <a class="cta_button btn btn-primary u_margin-lg" target="_blank" href="https://store.risevision.com/product/2048" link-cid="" translate="">common-header.plans.go-to-store</a></div><div ng-show="showRPPLink && proSubscriptionLinkVisible()" class="text-center u_margin-md-top"><a class="btn btn-link btn-lg" target="_blank" href="https://store.risevision.com/account/subscription/{{playerProSubscriptionId}}?cid={{companyId}}" translate="">common-header.plans.individual-licenses</a> <a class="cta_button btn btn-primary u_margin-lg" target="_blank" href="https://store.risevision.com/account/subscription/{{playerProSubscriptionId}}?cid={{companyId}}" translate="">common-header.plans.go-to-store</a></div></div><div class="modal-footer"></div></div>')}])}();